<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HomeKart - Cart</title>

    <style>
        body { background: #f1f3f6; margin: 0; font-family: Arial; }
        .cart-container { width: 90%; max-width: 800px; background: white; margin: 30px auto; padding: 20px; border-radius: 10px; }
        .cart-item { display: flex; align-items: center; border-bottom: 1px solid #ddd; padding: 15px 0; }
        .cart-item img { width: 80px; height: 80px; border-radius: 8px; margin-right: 20px; }
        .cart-details { flex: 1; }
        .price { color: #388e3c; font-weight: bold; margin-top: 5px; }
        .remove-btn { background: red; color: white; padding: 6px 12px; border: none; border-radius: 5px; cursor: pointer; }
        .total-box { font-size: 22px; margin-top: 20px; text-align: right; font-weight: bold; }
        .back-btn { display: block; width: 220px; margin: 25px auto 10px; padding: 12px; background: #2874f0; color: white; text-align: center; text-decoration: none; font-size: 18px; border-radius: 6px; }
    </style>
</head>
<body>

    <div class="cart-container">
        <h2>Your Cart</h2>
        <div id="cartItems"></div>
        <div class="total-box" id="totalAmount">Total: ₹0</div>
    </div>

    <a id="backBtn" class="back-btn">← Back</a>

    <!-- FIREBASE IMPORTS -->
    <script type="module">
        import { auth } from "./firebase.js";
        import {
            getFirestore, doc, getDoc, updateDoc
        } from "https://www.gstatic.com/firebasejs/10.12.1/firebase-firestore.js";

        const db = getFirestore();

        // -----------------------------
        //   1. CHECK IF LOGGED IN
        // -----------------------------
        auth.onAuthStateChanged(async (user) => {
            if (!user) {
                alert("Please login to view your cart.");
                window.location.href = "login.html";
                return;
            }

            loadCartFirestore(user.uid);
        });

        // -----------------------------
        //   2. LOAD CART FROM FIRESTORE
        // -----------------------------
        async function loadCartFirestore(uid) {
            const ref = doc(db, "users", uid);
            const snap = await getDoc(ref);

            let cart = snap.exists() ? snap.data().cart || [] : [];

            let container = document.getElementById("cartItems");
            container.innerHTML = "";

            let total = 0;

            cart.forEach((item, index) => {
                total += Number(item.price);

                container.innerHTML += `
                    <div class="cart-item">
                        <img src="${item.img}" alt="Product">
                        <div class="cart-details">
                            <h3>${item.name}</h3>
                            <p class="price">₹${item.price}</p>
                        </div>
                        <button class="remove-btn" onclick="removeItem(${index})">Remove</button>
                    </div>
                `;
            });

            document.getElementById("totalAmount").innerText = "Total: ₹" + total;

            // store globally to remove later
            window.cartData = cart;
            window.userId = uid;
        }

        // -----------------------------
        //   3. REMOVE ITEM FROM CART
        // -----------------------------
        window.removeItem = async function (index) {
            window.cartData.splice(index, 1);

            const ref = doc(db, "users", window.userId);
            await updateDoc(ref, { cart: window.cartData });

            loadCartFirestore(window.userId);
        };

        // -----------------------------
        //   4. BACK BUTTON LOGIC
        // -----------------------------
        document.addEventListener("DOMContentLoaded", () => {
            let lastPage = localStorage.getItem("lastPage");
            if (!lastPage) lastPage = "index.html";
            document.getElementById("backBtn").href = lastPage;
        });

    </script>

</body>
</html>
